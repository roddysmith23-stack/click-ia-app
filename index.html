<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLICK IA | Enterprise Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;900&family=Chakra+Petch:wght@400;600;700&family=Oswald:wght@500&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <style>
        /* --- ESTTICA ENTERPRISE --- */
        :root { --primary: #00f2ea; --bg-dark: #050505; --glass: rgba(255, 255, 255, 0.05); }
        
        body { background-color: var(--bg-dark); color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .font-tech { font-family: 'Chakra Petch', sans-serif; }
        .font-impact { font-family: 'Oswald', sans-serif; }

        /* EFECTOS VISUALES */
        .glass-panel { 
            background: rgba(10, 10, 12, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
        }
        
        .tech-btn {
            background: white; color: black; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em;
            clip-path: polygon(10px 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%, 0 10px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .tech-btn:hover { background: var(--primary); transform: translateY(-2px); box-shadow: 0 0 30px rgba(0, 242, 234, 0.3); }
        .tech-btn:active { transform: scale(0.98); }

        .input-pro {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;
            font-family: 'Chakra Petch'; padding: 16px; width: 100%; border-radius: 4px;
            transition: border-color 0.3s;
        }
        .input-pro:focus { outline: none; border-color: var(--primary); }

        /* ANIMACIONES */
        @keyframes scanline { 0% { transform: translateY(-100%); } 100% { transform: translateY(100%); } }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 20%; background: linear-gradient(to bottom, transparent, var(--primary), transparent); opacity: 0.1; animation: scanline 3s linear infinite; pointer-events: none; }
        
        /* CANVAS WRAPPER */
        .canvas-container-wrapper {
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1), 0 20px 50px rgba(0,0,0,0.5);
            background-image:
                linear-gradient(45deg, #111 25%, transparent 25%),
                linear-gradient(-45deg, #111 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #111 75%),
                linear-gradient(-45deg, transparent 75%, #111 75%);
            background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        /* UTILS */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #000; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- CONFIGURACIN GLOBAL ---
        const API_VERSION = "v2.5-Enterprise";
        const DEFAULT_BG = "https://images.unsplash.com/photo-1620641788421-7a1c342ea42e?q=80&w=1974"; // Fallback elegante
        
        // --- ICONS (SVG OPTIMIZADOS) ---
        const Icon = ({ name, size=20, className="" }) => {
            const icons = {
                logo: <path d="M50 10L90 80C90 80 70 70 50 70C30 70 10 80 10 80L50 10Z" fill="currentColor"/>,
                upload: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" fill="none"/>,
                wand: <path d="M15 4V2m0 18v-2M4.93 19.07l1.41-1.41M19.07 4.93l-1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 19.07l-1.41-1.41M12 22v-2M12 2v2" stroke="currentColor" strokeWidth="2" fill="none"/>,
                download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" strokeWidth="2" fill="none"/>,
                layer: <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" strokeWidth="2" fill="none"/>,
                close: <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" strokeWidth="2" strokeLinecap="round" fill="none"/>,
                text: <path d="M4 7V4h16v3M9 20h6M12 4v16" stroke="currentColor" strokeWidth="2" strokeLinecap="round" fill="none"/>,
                trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" stroke="currentColor" strokeWidth="2" fill="none"/>,
                magic: <path d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.28 2.28a.75.75 0 001.06 0l2.28-2.28m-5.62 14.62l2.28 2.28a.75.75 0 001.06 0l2.28-2.28" stroke="currentColor" strokeWidth="2" fill="none"/>
            };
            return <svg width={size} height={size} viewBox={name === 'logo' ? "0 0 100 100" : "0 0 24 24"} className={className}>{icons[name]}</svg>;
        };

        // --- COMPONENTE: NANO-STUDIO (FABRIC.JS REWRITE) ---
        const NanoStudio = ({ backgroundUrl, logoUrl, initialData, onClose, tLang }) => {
            const canvasRef = useRef(null);
            const [fabricCanvas, setFabricCanvas] = useState(null);
            const [selectedObj, setSelectedObj] = useState(null);

            // Inicializar Fabric con configuraci贸n PRO
            useEffect(() => {
                const initCanvas = new fabric.Canvas(canvasRef.current, {
                    width: 1080, // Resoluci贸n interna HD
                    height: 1080,
                    backgroundColor: '#000000',
                    preserveObjectStacking: true, // Importante para capas
                    selectionColor: 'rgba(0, 242, 234, 0.1)',
                    selectionBorderColor: '#00f2ea',
                    selectionLineWidth: 2
                });

                // Personalizar controles (Look & Feel Tech)
                fabric.Object.prototype.set({
                    transparentCorners: false,
                    cornerColor: '#ffffff',
                    cornerStrokeColor: '#000000',
                    borderColor: '#00f2ea',
                    cornerSize: 12,
                    padding: 10,
                    cornerStyle: 'circle'
                });

                setFabricCanvas(initCanvas);

                // Eventos
                initCanvas.on('selection:created', (e) => setSelectedObj(e.selected[0]));
                initCanvas.on('selection:updated', (e) => setSelectedObj(e.selected[0]));
                initCanvas.on('selection:cleared', () => setSelectedObj(null));

                // 1. Cargar Fondo (Capa 0 - Bloqueada)
                fabric.Image.fromURL(backgroundUrl, (img) => {
                    if(!img) return;
                    img.set({
                        originX: 'center', originY: 'center',
                        left: 540, top: 540,
                        selectable: false, evented: false // El fondo no se toca
                    });
                    // Modo "Cover"
                    const scale = Math.max(1080 / img.width, 1080 / img.height);
                    img.scale(scale);
                    initCanvas.add(img);
                    initCanvas.sendToBack(img);

                    // 2. Cargar Logo (Capa 1)
                    if (logoUrl) {
                        fabric.Image.fromURL(logoUrl, (logo) => {
                            if(logo) {
                                logo.scaleToWidth(250); // Tama帽o inicial sensato
                                logo.set({
                                    left: 540, top: 540,
                                    originX: 'center', originY: 'center'
                                });
                                initCanvas.add(logo);
                                initCanvas.setActiveObject(logo);
                            }
                        }, { crossOrigin: 'anonymous' });
                    }

                    // 3. Texto Inicial (Capa 2)
                    const text = new fabric.IText(initialData?.copy_viral || "TU MARCA", {
                        left: 540, top: 150,
                        fontFamily: 'Chakra Petch',
                        fill: '#ffffff',
                        fontSize: 60,
                        originX: 'center',
                        fontWeight: 'bold',
                        shadow: new fabric.Shadow({ color: 'rgba(0,0,0,0.8)', blur: 20, offsetX: 0, offsetY: 5 }),
                        textAlign: 'center'
                    });
                    initCanvas.add(text);

                }, { crossOrigin: 'anonymous' }); // CORS es vital para exportar

                return () => { initCanvas.dispose(); }
            }, []);

            // --- FUNCIN SMART BLEND (PIXEL MANIPULATION) ---
            const removeWhiteBackground = () => {
                if (!fabricCanvas || !selectedObj || selectedObj.type !== 'image') return alert("Selecciona un logo/imagen primero.");
                
                const imgObj = selectedObj;
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                tempCanvas.width = imgObj._element.width;
                tempCanvas.height = imgObj._element.height;
                tempCtx.drawImage(imgObj._element, 0, 0);

                const imgData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imgData.data;

                // Algoritmo de Umbral Mejorado
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i], g = data[i+1], b = data[i+2];
                    // Si es casi blanco (>230 en RGB), hazlo transparente
                    if (r > 230 && g > 230 && b > 230) {
                        data[i+3] = 0; // Alpha 0
                    }
                }

                tempCtx.putImageData(imgData, 0, 0);

                const newImg = new fabric.Image(tempCanvas);
                newImg.set({
                    left: imgObj.left, top: imgObj.top,
                    scaleX: imgObj.scaleX, scaleY: imgObj.scaleY,
                    angle: imgObj.angle
                });

                fabricCanvas.remove(imgObj);
                fabricCanvas.add(newImg);
                fabricCanvas.setActiveObject(newImg);
                fabricCanvas.renderAll();
            };

            const addText = () => {
                const text = new fabric.IText("EDITAME", {
                    left: 540, top: 540, fontFamily: 'Oswald', fill: '#00f2ea', fontSize: 80, originX: 'center'
                });
                fabricCanvas.add(text);
                fabricCanvas.setActiveObject(text);
            };

            const download4K = () => {
                if (!fabricCanvas) return;
                // MULTIPLIER 4 = 4320px x 4320px (Calidad Impresi贸n)
                const dataURL = fabricCanvas.toDataURL({
                    format: 'png',
                    quality: 1,
                    multiplier: 4 
                });
                const link = document.createElement('a');
                link.download = `CLICK_IA_4K_${Date.now()}.png`;
                link.href = dataURL;
                link.click();
            };

            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col fade-in">
                    {/* TOOLBAR */}
                    <div className="h-16 border-b border-gray-800 flex items-center justify-between px-6 bg-[#0a0a0a]">
                        <div className="flex items-center gap-2 text-white font-bold font-tech">
                            <span className="text-[#00f2ea]">NANO</span>STUDIO
                        </div>
                        <div className="flex gap-2">
                             <button onClick={download4K} className="bg-[#00f2ea] hover:bg-white text-black px-6 py-2 rounded-sm font-bold text-xs uppercase transition-colors flex items-center gap-2">
                                <Icon name="download" size={16}/> EXPORTAR 4K
                            </button>
                            <button onClick={onClose} className="p-2 hover:bg-red-500/20 text-gray-400 hover:text-red-500 rounded transition-colors">
                                <Icon name="close" />
                            </button>
                        </div>
                    </div>

                    <div className="flex-1 flex overflow-hidden">
                        {/* SIDEBAR */}
                        <div className="w-20 md:w-72 bg-[#111] border-r border-gray-800 flex flex-col p-4 gap-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <button onClick={addText} className="p-4 border border-gray-700 rounded hover:bg-[#00f2ea]/10 hover:border-[#00f2ea] transition-all flex flex-col items-center gap-2 text-xs text-gray-400 group">
                                    <Icon name="text" className="group-hover:text-[#00f2ea]" />
                                    <span className="hidden md:block">Texto</span>
                                </button>
                                <button onClick={removeWhiteBackground} className="p-4 border border-gray-700 rounded hover:bg-purple-500/10 hover:border-purple-500 transition-all flex flex-col items-center gap-2 text-xs text-gray-400 group">
                                    <Icon name="magic" className="group-hover:text-purple-400" />
                                    <span className="hidden md:block">Quitar Fondo</span>
                                </button>
                            </div>

                            {/* PROPIEDADES CONTEXTUALES */}
                            {selectedObj && (
                                <div className="mt-4 p-4 bg-black/40 rounded border border-gray-800 fade-in hidden md:block">
                                    <p className="text-[10px] uppercase text-gray-500 font-bold mb-2">Propiedades</p>
                                    <div className="flex flex-col gap-3">
                                        <div className="flex justify-between items-center">
                                            <span className="text-xs text-gray-400">Opacidad</span>
                                            <input type="range" min="0.1" max="1" step="0.1" 
                                                defaultValue={selectedObj.opacity} 
                                                onChange={(e) => { selectedObj.set('opacity', parseFloat(e.target.value)); fabricCanvas.renderAll(); }}
                                                className="w-20 accent-[#00f2ea]"
                                            />
                                        </div>
                                        {selectedObj.type === 'i-text' && (
                                            <div className="flex justify-between items-center">
                                                <span className="text-xs text-gray-400">Color</span>
                                                <input type="color" className="bg-transparent border-none h-6 w-6" 
                                                    onChange={(e) => { selectedObj.set('fill', e.target.value); fabricCanvas.renderAll(); }}
                                                />
                                            </div>
                                        )}
                                        <button onClick={() => { fabricCanvas.remove(selectedObj); fabricCanvas.discardActiveObject(); fabricCanvas.renderAll(); setSelectedObj(null); }} className="w-full py-2 bg-red-900/20 text-red-500 text-xs rounded border border-red-900/50 hover:bg-red-900/40">
                                            ELIMINAR CAPA
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* CANVAS AREA - AUTO SCALING */}
                        <div className="flex-1 bg-[#050505] flex items-center justify-center p-8 overflow-hidden relative canvas-container-wrapper">
                            {/* TRUCO CTO: El contenedor tiene un tama帽o fijo de 1080x1080 en l贸gica, 
                                pero usamos CSS 'transform: scale()' para que quepa en la pantalla del usuario.
                            */}
                            <div className="shadow-2xl ring-1 ring-white/10" style={{ width: 'fit-content', height: 'fit-content', transform: 'scale(0.6)', transformOrigin: 'center' }}>
                                <canvas ref={canvasRef} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            const [step, setStep] = useState('upload'); // upload, processing, editor
            const [apiKey, setApiKey] = useState(localStorage.getItem('click_api_key') || '');
            const [data, setData] = useState({ product: '', logo: null, instructions: '', style: 'Cinematic' });
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleFile = (e, field) => {
                const file = e.target.files[0];
                if(file) setData({...data, [field]: URL.createObjectURL(file)});
            };

            // --- CEREBRO IA: SYSTEM INSTRUCTION ACTUALIZADO ---
            const generateCampaign = async () => {
                if(!apiKey) return alert("Por favor ingresa tu API Key de Gemini");
                if(!data.product) return alert("Sube una imagen de referencia o describe tu producto");

                setLoading(true);
                setStep('processing');

                // 1. GENERAR PROMPT PARA GEMINI
                const promptSystem = `
                    ACT AS A WORLD-CLASS MARKETING DIRECTOR & ART DIRECTOR.
                    INPUT: Product/Service: "${data.instructions || 'Generic Product'}", Style: "${data.style}".
                    
                    TASK: Generate a strict JSON response.
                    
                    JSON STRUCTURE:
                    {
                        "prompt_imagen_comercial": "ENGLISH PROMPT for an AI Image Generator. Describe a HIGH-END BACKGROUND SCENE (8k, unreal engine 5, cinematic lighting, shallow depth of field). CRITICAL: THE CENTER MUST BE CLEAN/EMPTY/NEGATIVE SPACE for product placement. NO TEXT, NO LOGOS in the generated image.",
                        "copy_viral": "Spanish marketing copy. Short, punchy, emoji-rich, viral potential.",
                        "color_palette": ["#Hex1", "#Hex2"]
                    }
                `;

                try {
                    // Simulaci贸n de llamada a Gemini (Reemplazar con fetch real)
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: [{ parts: [{ text: promptSystem }] }] })
                    });
                    
                    const jsonRaw = await response.json();
                    const textResponse = jsonRaw.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    // Limpieza JSON Robusta
                    let aiData;
                    try {
                        const cleanJson = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                        aiData = JSON.parse(cleanJson);
                    } catch (e) {
                        console.warn("JSON Parse Fallback", e);
                        aiData = { 
                            prompt_imagen_comercial: "Luxury minimalist background, podium, cinematic lighting, 8k, blurry background", 
                            copy_viral: "隆Descubre la revoluci贸n!  #Innovation" 
                        };
                    }

                    // 2. GENERAR IMAGEN (Pollinations como Proxy Gratuito de Calidad)
                    // Truco: A帽adir 'nologo' y seed aleatoria
                    const imagePrompt = encodeURIComponent(aiData.prompt_imagen_comercial + " --no text --no logo");
                    const generatedImage = `https://image.pollinations.ai/prompt/${imagePrompt}?width=1080&height=1080&nologo=true&seed=${Math.floor(Math.random()*999)}`;

                    // Esperar un poco para simular carga pesada (UX)
                    await new Promise(r => setTimeout(r, 2000));

                    setResult({ bg: generatedImage, ...aiData });
                    setLoading(false);
                    setStep('editor');

                } catch (error) {
                    console.error(error);
                    alert("Error conectando con la Matrix. Revisa tu API Key.");
                    setLoading(false);
                    setStep('upload');
                }
            };

            return (
                <div className="min-h-screen text-white font-sans selection:bg-[#00f2ea] selection:text-black">
                    
                    {/* VISTA 1: UPLOAD & SETUP */}
                    {step === 'upload' && (
                        <div className="max-w-2xl mx-auto p-6 pt-20 fade-in">
                            <div className="text-center mb-12">
                                <h1 className="text-5xl font-black font-tech tracking-tighter mb-2">CLICK<span className="text-[#00f2ea]">.IA</span></h1>
                                <p className="text-gray-400 uppercase tracking-[0.3em] text-xs">Enterprise Marketing Automation</p>
                            </div>

                            <div className="glass-panel p-8 rounded-2xl space-y-6">
                                <div>
                                    <label className="text-xs font-bold text-[#00f2ea] uppercase mb-2 block">Gemini API Key</label>
                                    <input type="password" value={apiKey} onChange={e => {setApiKey(e.target.value); localStorage.setItem('click_api_key', e.target.value)}} className="input-pro" placeholder="AIzaSy..." />
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className={`border-2 border-dashed rounded-xl h-40 flex flex-col items-center justify-center cursor-pointer transition-all ${data.product ? 'border-[#00f2ea] bg-[#00f2ea]/10' : 'border-gray-700 hover:border-gray-500'}`} onClick={() => document.getElementById('prodInput').click()}>
                                        {data.product ? <img src={data.product} className="h-full w-full object-contain p-2"/> : <><Icon name="upload" className="mb-2 text-gray-500"/><span className="text-xs text-gray-500 uppercase">Ref. Producto</span></>}
                                        <input id="prodInput" type="file" className="hidden" onChange={e => handleFile(e, 'product')} />
                                    </div>
                                    <div className={`border-2 border-dashed rounded-xl h-40 flex flex-col items-center justify-center cursor-pointer transition-all ${data.logo ? 'border-purple-500 bg-purple-500/10' : 'border-gray-700 hover:border-gray-500'}`} onClick={() => document.getElementById('logoInput').click()}>
                                        {data.logo ? <img src={data.logo} className="h-full w-full object-contain p-2"/> : <><Icon name="logo" className="mb-2 text-gray-500"/><span className="text-xs text-gray-500 uppercase">Logo Empresa</span></>}
                                        <input id="logoInput" type="file" className="hidden" onChange={e => handleFile(e, 'logo')} />
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">驴Qu茅 vendemos hoy?</label>
                                    <textarea className="input-pro" rows="2" placeholder="Ej: Hamburguesa doble carne, jugosa, estilo gourmet..." onChange={e => setData({...data, instructions: e.target.value})}></textarea>
                                </div>

                                <button onClick={generateCampaign} className="tech-btn w-full py-4 text-xl font-bold flex items-center justify-center gap-2">
                                    <Icon name="wand" /> GENERAR CAMPAA
                                </button>
                            </div>
                        </div>
                    )}

                    {/* VISTA 2: LOADING */}
                    {step === 'processing' && (
                        <div className="fixed inset-0 flex flex-col items-center justify-center bg-black z-50">
                            <div className="w-24 h-24 border-4 border-[#00f2ea] border-t-transparent rounded-full animate-spin mb-8 shadow-[0_0_50px_rgba(0,242,234,0.4)]"></div>
                            <h2 className="text-2xl font-tech font-bold animate-pulse">NEURAL ENGINE WORKING...</h2>
                            <p className="text-[#00f2ea] font-mono text-xs mt-4">GENERATING 8K ASSETS</p>
                        </div>
                    )}

                    {/* VISTA 3: NANO-STUDIO */}
                    {step === 'editor' && result && (
                        <NanoStudio 
                            backgroundUrl={result.bg} 
                            logoUrl={data.logo}
                            initialData={result}
                            onClose={() => setStep('upload')}
                            tLang={{}}
                        />
                    )}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

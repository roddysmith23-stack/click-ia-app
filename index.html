<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAG.IA - Marketing Studio</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Outfit:wght@300;700;900&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

    <style>
        /* --- ESTILOS VISUALES (MAG.IA ORIGINAL) --- */
        :root {
            --bg-gradient: linear-gradient(180deg, #0f172a 0%, #312e81 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --accent: #38bdf8;
        }
        body { 
            margin: 0; font-family: 'Inter', sans-serif; 
            background: var(--bg-gradient); color: white; min-height: 100vh; 
        }
        h1, h2, h3, .font-display { font-family: 'Outfit', sans-serif; }
        
        .crystal-card {
            background: var(--glass-bg); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); 
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            border-radius: 24px; 
        }
        
        .glass-input { 
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255,255,255,0.2); 
            color: #fff; padding: 12px; width: 100%; border-radius: 12px; margin-bottom: 10px;
            font-family: 'Inter', sans-serif;
        }
        .glass-input:focus { outline: none; border-color: var(--accent); background: rgba(0,0,0,0.5); }
        
        .tech-btn { 
            background: white; color: black; font-family: 'Outfit', sans-serif; font-weight: 800; 
            border-radius: 99px; padding: 14px 30px; border: none; cursor: pointer;
            transition: transform 0.2s; text-transform: uppercase; letter-spacing: 1px;
            width: 100%; margin-top: 10px;
        }
        .tech-btn:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(255,255,255,0.4); }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Carga */
        .loader { border: 4px solid rgba(255,255,255,0.1); border-left-color: #38bdf8; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ---------------------------------------------------------
        // ⚠️ CONFIGURACIÓN: PEGA TU API KEY AQUÍ
        // ---------------------------------------------------------
        const apiKey = ""; 
        // ---------------------------------------------------------

        // --- ICONOS ---
        const Icons = {
            ArrowLeft: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>,
            Upload: () => <svg className="w-8 h-8 mx-auto opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
        };

        // --- PROMPT MAESTRO (Lógica de Negocio) ---
        const MOTHER_PROMPT_INSTRUCTION = `Actúa como un Director Creativo de Élite.
OBJETIVO: Recibir datos y generar un JSON para una campaña visual.

INPUTS:
- Producto: {{PRODUCT_DESC}}
- Estilo: {{STYLE}}
- Target: {{TARGET}}

REGLAS IMAGEN ('image_prompt'):
1. Describe fielmente el producto.
2. Aplica el estilo visual {{STYLE}}.
3. IMPERATIVO: Agrega '--no text, no watermark, no letters' al final.

REGLAS COPY ('viral_copy'):
1. Texto persuasivo para redes.
2. INCLUIR PRECIO: {{PRICE}} y PROMO: {{PROMO}} obligatoriamente.

FORMATO JSON ESPERADO:
{
  "image_prompt": "Description in English of {{PRODUCT_DESC}}, {{STYLE}} style, 8k, professional lighting --no text",
  "viral_copy": "Texto en español con emojis...",
  "viral_score": 9.5
}`;

        // --- SERVICIO GEMINI ---
        const callGemini = async (prompt) => {
            if (!apiKey) throw new Error("Falta la API Key en el código");
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                
                if (!response.ok) throw new Error("Error en API Gemini");
                
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                return JSON.parse(text);
            } catch (e) {
                console.error(e);
                // Fallback de emergencia para no romper la app
                return {
                    image_prompt: "High quality product photography, cinematic lighting, 8k --no text",
                    viral_copy: "¡Descubre nuestro nuevo producto! Calidad increíble al mejor precio. #Lanzamiento",
                    viral_score: 5.0
                };
            }
        };

        // --- VISTA 1: FORMULARIO (INPUTS) ---
        const QuestionView = ({ onNext, setUserData }) => {
            const [formData, setFormData] = useState({
                companyName: "", productDesc: "", target: "", 
                style: "Cinematic", price: "", promo: "", logoFile: null
            });

            const handleChange = (e) => setFormData({...formData, [e.target.name]: e.target.value});
            
            const handleLogo = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => setFormData(prev => ({ ...prev, logoFile: ev.target.result }));
                    reader.readAsDataURL(file);
                }
            };

            const handleSubmit = () => {
                if(!formData.productDesc) return alert("Por favor describe el producto");
                setUserData(formData);
                onNext();
            };

            return (
                <div className="flex items-center justify-center min-h-screen p-4 fade-in">
                    <div className="crystal-card p-8 max-w-2xl w-full">
                        <h2 className="text-3xl font-display font-bold mb-6 text-center">Configura tu Campaña</h2>
                        <div className="grid md:grid-cols-2 gap-4">
                            <input name="companyName" placeholder="Nombre Empresa" className="glass-input" onChange={handleChange} />
                            <input name="target" placeholder="Público Objetivo" className="glass-input" onChange={handleChange} />
                            <textarea name="productDesc" placeholder="Describe tu Producto (Ej: Hamburguesa doble queso...)" className="glass-input h-32 md:col-span-2" onChange={handleChange}></textarea>
                            
                            <select name="style" className="glass-input text-gray-300" onChange={handleChange}>
                                <option value="Cinematic">Estilo: Cinematográfico</option>
                                <option value="Minimalist">Estilo: Minimalista</option>
                                <option value="Neon">Estilo: Neon Cyberpunk</option>
                                <option value="Studio">Estilo: Estudio Fotográfico</option>
                            </select>
                            
                            <input name="price" placeholder="Precio (Ej: $9.99)" className="glass-input" onChange={handleChange} />
                            <input name="promo" placeholder="Promo (Ej: 2x1)" className="glass-input" onChange={handleChange} />
                            
                            <div className="md:col-span-2 border border-dashed border-white/30 rounded-xl p-4 text-center relative hover:bg-white/5 cursor-pointer">
                                <input type="file" accept="image/*" onChange={handleLogo} className="absolute inset-0 opacity-0 cursor-pointer" />
                                <div className="pointer-events-none">
                                    {formData.logoFile ? <p className="text-green-400 font-bold">¡Logo Cargado!</p> : <><Icons.Upload /><span className="text-xs">Sube tu Logo (Opcional)</span></>}
                                </div>
                            </div>
                        </div>
                        <button onClick={handleSubmit} className="tech-btn mt-6">GENERAR CAMPAÑA</button>
                    </div>
                </div>
            );
        };

        // --- VISTA 2: PROCESAMIENTO (MOTOR) ---
        const ProcessingView = ({ onFinish, userData }) => {
            const [status, setStatus] = useState("Conectando Neural Engine...");

            useEffect(() => {
                const run = async () => {
                    // 1. Reemplazo de variables en el prompt
                    let prompt = MOTHER_PROMPT_INSTRUCTION
                        .replace('{{PRODUCT_DESC}}', userData.productDesc)
                        .replace(/{{PRODUCT_DESC}}/g, userData.productDesc) // Repetir para asegurar
                        .replace(/{{STYLE}}/g, userData.style)
                        .replace('{{TARGET}}', userData.target)
                        .replace('{{PRICE}}', userData.price)
                        .replace('{{PROMO}}', userData.promo);

                    setStatus("Diseñando Estrategia Visual...");
                    const data = await callGemini(prompt);
                    
                    setStatus("Generando Activos...");
                    setTimeout(() => onFinish(data), 1000);
                };
                run();
            }, []);

            return (
                <div className="flex flex-col items-center justify-center min-h-screen fade-in text-center p-4">
                    <div className="loader mb-6"></div>
                    <h2 className="text-2xl font-bold mb-2">PROCESANDO</h2>
                    <p className="text-blue-300 font-mono text-sm">{status}</p>
                </div>
            );
        };

        // --- VISTA 3: MAGIC STUDIO (RESULTADO) ---
        const MagicStudio = ({ onClose, aiData, userData }) => {
            const canvasRef = useRef(null);
            const fabricRef = useRef(null);

            useEffect(() => {
                if(!canvasRef.current || !aiData) return;

                // URL de Pollinations con el prompt de Gemini
                const bgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(aiData.image_prompt)}?width=1080&height=1080&nologo=true&seed=${Math.random()}`;

                const canvas = new fabric.Canvas(canvasRef.current, { width: 600, height: 600, backgroundColor: '#000' });
                fabricRef.current = canvas;

                // Cargar Fondo
                fabric.Image.fromURL(bgUrl, (img) => {
                    img.scaleToWidth(600);
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                }, { crossOrigin: 'anonymous' });

                // Cargar Logo del Usuario
                if(userData.logoFile) {
                    fabric.Image.fromURL(userData.logoFile, (img) => {
                        img.scaleToWidth(120);
                        img.set({ left: 460, top: 20 });
                        canvas.add(img);
                    });
                } else {
                    // Texto por defecto si no hay logo
                    const text = new fabric.Text(userData.companyName || "TU MARCA", { 
                        left: 20, top: 20, fontSize: 30, fill: 'white', fontFamily: 'Outfit', fontWeight: 'bold',
                        shadow: 'rgba(0,0,0,0.8) 2px 2px 5px'
                    });
                    canvas.add(text);
                }
            }, []);

            const download = () => {
                const link = document.createElement('a');
                link.download = 'campaña-magia.png';
                link.href = fabricRef.current.toDataURL({ format: 'png', multiplier: 2 });
                link.click();
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4 fade-in">
                    <div className="w-full max-w-6xl h-[90vh] crystal-card flex flex-col md:flex-row overflow-hidden border border-white/20">
                        {/* ÁREA VISUAL */}
                        <div className="flex-1 bg-gray-900 flex items-center justify-center p-4 relative">
                            <button onClick={onClose} className="absolute top-4 left-4 bg-white/10 p-2 rounded-full hover:bg-white/20"><Icons.ArrowLeft /></button>
                            <div className="shadow-2xl border-4 border-white/5 rounded-lg overflow-hidden">
                                <canvas ref={canvasRef} />
                            </div>
                        </div>

                        {/* BARRA LATERAL */}
                        <div className="w-full md:w-96 bg-gray-900/50 backdrop-blur-md p-6 flex flex-col gap-6 border-l border-white/10 overflow-y-auto">
                            <div>
                                <h3 className="text-2xl font-display font-bold">MAGIC STUDIO</h3>
                                <p className="text-xs opacity-50">Editor & Generador IA</p>
                            </div>

                            <div className="bg-blue-900/30 border border-blue-500/30 p-4 rounded-xl">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-xs font-bold text-blue-300">COPY VIRAL GENERADO</span>
                                    <span className="text-[10px] bg-blue-500 px-2 py-0.5 rounded-full">{aiData?.viral_score}/10</span>
                                </div>
                                <p className="text-sm italic opacity-90">{aiData?.viral_copy || "Generando..."}</p>
                            </div>

                            <div className="mt-auto space-y-3">
                                <button onClick={download} className="tech-btn bg-blue-500 text-white hover:bg-blue-600">DESCARGAR ARTE</button>
                                <button onClick={onClose} className="text-xs text-center w-full opacity-50 hover:opacity-100">VOLVER AL INICIO</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        const App = () => {
            const [view, setView] = useState('landing');
            const [userData, setUserData] = useState({});
            const [aiData, setAiData] = useState(null);

            return (
                <React.StrictMode>
                    {view === 'landing' && (
                        <div className="flex flex-col items-center justify-center min-h-screen text-center p-4 fade-in">
                            <h1 className="text-7xl md:text-9xl font-black font-display mb-4 tracking-tighter">MAG.IA</h1>
                            <p className="mb-8 font-light text-xl opacity-80">El futuro del Marketing Automatizado</p>
                            <button onClick={() => setView('questions')} className="tech-btn max-w-xs text-lg shadow-xl">INICIAR PROYECTO</button>
                            {!apiKey && <p className="text-red-400 mt-4 font-bold bg-red-900/20 px-4 py-2 rounded">⚠️ FALTA API KEY EN EL CÓDIGO</p>}
                        </div>
                    )}
                    {view === 'questions' && <QuestionView onNext={() => setView('processing')} setUserData={setUserData} />}
                    {view === 'processing' && <ProcessingView userData={userData} onFinish={(data) => { setAiData(data); setView('studio'); }} />}
                    {view === 'studio' && <MagicStudio onClose={() => setView('landing')} aiData={aiData} userData={userData} />}
                </React.StrictMode>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
